<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏ –¥–ª—è –¥–≤–æ–∏—Ö ‚ù§Ô∏è</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: linear-gradient(135deg, #ff9a9e, #fad0c4);
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #333;
    }
    h1 { color: white; margin-bottom: 10px; }
    #status { font-size: 1.5em; margin: 20px; color: white; }
    #board {
      display: grid;
      grid-template-columns: repeat(3, 100px);
      grid-gap: 10px;
      margin: 20px auto;
    }
    .cell {
      width: 100px;
      height: 100px;
      background: white;
      border-radius: 15px;
      font-size: 70px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .cell:hover { background: #f0f0f0; }
    button {
      padding: 12px 30px;
      font-size: 1.2em;
      background: #ff4757;
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      margin-top: 20px;
    }
    button:hover { background: #ff3742; }
    #link {
      background: white;
      padding: 15px;
      border-radius: 10px;
      margin: 20px;
      word-break: break-all;
      max-width: 80%;
    }
  </style>
</head>
<body>
  <h1>–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏ –¥–ª—è –≤–ª—é–±–ª—ë–Ω–Ω—ã—Ö ‚ù§Ô∏è</h1>
  <div id="status">–û–∂–∏–¥–∞–µ–º –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞...</div>
  <div id="board"></div>
  <button onclick="resetGame()">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
  <div id="link" style="display:none;">–û—Ç–ø—Ä–∞–≤—å —ç—Ç—É —Å—Å—ã–ª–∫—É –ª—é–±–∏–º–æ–π ‚ù§Ô∏è<br><span id="url"></span></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDS3YUcSW26NDSJJAxbvQdJDwHTpUN-k5A",
      authDomain: "xox-gamelove.firebaseapp.com",
      databaseURL: "https://xox-gamelove-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "xox-gamelove",
      storageBucket: "xox-gamelove.firebasestorage.app",
      messagingSenderId: "99410167270",
      appId: "1:99410167270:web:c44b4f7f22a88a2db34227"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∫–æ–º–Ω–∞—Ç—ã –∏–∑ URL –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π
    const urlParams = new URLSearchParams(window.location.search);
    let roomId = urlParams.get('room');
    if (!roomId) {
      roomId = Math.random().toString(36).substr(2, 9);
      history.replaceState(null, null, '?room=' + roomId);
    }

    const roomRef = db.ref('rooms/' + roomId);
    const boardRef = roomRef.child('board');
    const turnRef = roomRef.child('turn');
    const playersRef = roomRef.child('players');
    const winnerRef = roomRef.child('winner');

    let mySymbol = null;
    let isMyTurn = false;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞
    document.getElementById('url').textContent = location.href;
    document.getElementById('link').style.display = 'block';

    // –°–æ–∑–¥–∞—ë–º –ø–æ–ª–µ
    const board = document.getElementById('board');
    for (let i = 0; i < 9; i++) {
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.dataset.index = i;
      cell.addEventListener('click', makeMove);
      board.appendChild(cell);
    }

    function makeMove(e) {
      const idx = e.target.dataset.index;
      if (!isMyTurn || e.target.textContent || winnerRef.val()) return;
      boardRef.child(idx).set(mySymbol);
      turnRef.set(mySymbol === 'X' ? 'O' : 'X');
    }

    function resetGame() {
      boardRef.set(Array(9).fill(null));
      turnRef.set('X');
      winnerRef.set(null);
      roomRef.child('players').set(0);
      document.getElementById('status').textContent = '–û–∂–∏–¥–∞–µ–º –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞...';
    }

    // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
    boardRef.on('value', snap => {
      const data = snap.val() || Array(9).fill(null);
      document.querySelectorAll('.cell').forEach((cell, i) => {
        cell.textContent = data[i] || '';
      });
      checkWinner(data);
    });

    turnRef.on('value', snap => {
      const currentTurn = snap.val() || 'X';
      isMyTurn = (mySymbol === currentTurn);
      document.getElementById('status').textContent = 
        winnerRef.val() ? `–ü–æ–±–µ–¥–∏–ª ${winnerRef.val() === 'draw' ? '–Ω–∏—á—å—è üòò' : winnerRef.val() + ' üéâ'}`
        : isMyTurn ? '–¢–≤–æ–π —Ö–æ–¥!' : `–•–æ–¥–∏—Ç ${currentTurn === 'X' ? '‚ùå' : '‚≠ï'}`;
    });

    // –ü–æ–¥—Å—á—ë—Ç –∏–≥—Ä–æ–∫–æ–≤ –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å–∏–º–≤–æ–ª–æ–≤
    playersRef.on('value', count => {
      if (count === null) playersRef.set(0);
      if (mySymbol) return;

      const newCount = (count || 0) + 1;
      playersRef.set(newCount);

      if (newCount === 1) {
        mySymbol = 'X';
        document.getElementById('status').textContent = '–¢—ã ‚ùå ‚Äî –∂–¥—ë–º –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞...';
      } else if (newCount === 2) {
        mySymbol = 'O';
        document.getElementById('status').textContent = '–¢—ã ‚≠ï ‚Äî —Ö–æ–¥–∏—Ç ‚ùå';
      }
    });

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–±–µ–¥—ã
    function checkWinner(board) {
      const win = [
        [0,1,2],[3,4,5],[6,7,8],
        [0,3,6],[1,4,7],[2,5,8],
        [0,4,8],[2,4,6]
      ];
      for (let c of win) {
        if (board[c[0]] && board[c[0]] === board[c[1]] && board[c[0]] === board[c[2]]) {
          winnerRef.set(board[c[0]]);
          return;
        }
      }
      if (board.every(v => v)) winnerRef.set('draw');
    }

    // –ü—Ä–∏ –≤—ã—Ö–æ–¥–µ —É–º–µ–Ω—å—à–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –∏–≥—Ä–æ–∫–æ–≤
    window.addEventListener('beforeunload', () => {
      playersRef.transaction(c => (c || 1) - 1);
    });
  </script>
</body>
</html>
