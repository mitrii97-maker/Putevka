<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–†–∞–∑–±–µ–π —è–π—Ü–æ –≤–º–µ—Å—Ç–µ! ü•öüí•</title>

  <!-- –ù–æ–≤—ã–π Firebase SDK v10+ (–º–æ–¥—É–ª—å–Ω—ã–π) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, runTransaction, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // –¢–≤–æ–π –∫–æ–Ω—Ñ–∏–≥ (—É–∂–µ –≤—Å—Ç–∞–≤–ª–µ–Ω)
    const firebaseConfig = {
      apiKey: "AIzaSyAzGea6sRTQek_bYAOnJdvKjKxd5sRgX7E",
      authDomain: "klicker-love.firebaseapp.com",
      databaseURL: "https://klicker-love-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "klicker-love",
      storageBucket: "klicker-love.firebasestorage.app",
      messagingSenderId: "805841292732",
      appId: "1:805841292732:web:250fbb2902eabc42472fb9",
      measurementId: "G-3M0GSCFXZN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // –û–¥–Ω–∞ –æ–±—â–∞—è –∫–æ–º–Ω–∞—Ç–∞
    const roomRef = ref(db, "egg_room");
    const clicksRef = ref(db, "egg_room/clicks");
    const messagesRef = ref(db, "egg_room/messages");

    // –ò–º—è –∏–≥—Ä–æ–∫–∞
    const myName = prompt("–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç? ‚ù§Ô∏è", "–õ—é–±–∏–º–∫–∞ " + Math.floor(Math.random()*999)) || "–ê–Ω–æ–Ω–∏–º";

    // ==================== –°–ß–Å–¢–ß–ò–ö –ö–õ–ò–ö–û–í ====================
    onValue(clicksRef, (snapshot) => {
      let clicks = snapshot.val();
      if (clicks === null) clicks = 1000; // –Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

      document.getElementById("clicks").textContent = clicks;

      if (clicks <= 0) {
        document.getElementById("egg").style.display = "none";
        document.getElementById("counter").style.display = "none";
        document.getElementById("win").style.display = "block";
      }
    });

    document.getElementById("egg").onclick = () => {
      runTransaction(clicksRef, (current) => {
        if (current === null) return 1000;
        return current > 0 ? current - 1 : 0;
      });
    };

    // ==================== –ß–ê–¢ ====================
    const chatDiv = document.getElementById("chat");
    const input = document.getElementById("msg");

    // –ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    onValue(messagesRef, (snapshot) => {
      chatDiv.innerHTML = "";
      snapshot.forEach(child => {
        const msg = child.val();
        const div = document.createElement("div");
        div.className = "msg" + (msg.name === myName ? " my" : "");
        div.innerHTML = `<b>${msg.name}:</b> ${msg.text}`;
        chatDiv.appendChild(div);
      });
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }, { onlyOnce: false });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && input.value.trim()) {
        push(messagesRef, {
          name: myName,
          text: input.value.trim(),
          time: serverTimestamp()
        });
        input.value = "";
      }
    });

    // –ß—Ç–æ–±—ã —á–∞—Ç –Ω–µ —Ä–æ—Å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å–æ–æ–±—â–µ–Ω–∏–π
    onValue(messagesRef, (snapshot) => {
      const updates = {};
      let count = 0;
      snapshot.forEach(child => {
        count++;
        if (count <= snapshot.size - 100) {
          updates[child.key] = null;
        }
      });
      if (count > 100) set(ref(db, "egg_room/messages"), updates);
    }, { onlyOnce: false });
  </script>

  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #fff8d6; margin: 0; padding: 20px; }
    h1 { color: #d4380d; }
    #egg { font-size: 200px; cursor: pointer; user-select: none; transition: 0.1s; margin: 20px; }
    #egg:active { transform: scale(0.93); }
    #counter { font-size: 50px; margin: 20px; color: #d4380d; }
    #win { display: none; font-size: 60px; color: #ffc107; text-shadow: 3px 3px #ff3d00; margin: 50px; animation: pulse 1s infinite; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    #chat { width: 90%; max-width: 600px; margin: 30px auto; height: 350px; overflow-y: auto; border: 3px solid #ffa39e; border-radius: 15px; padding: 15px; background: white; text-align: left; }
    #msg { width: 78%; padding: 15px; font-size: 18px; border: 2px solid #ffa39e; border-radius: 10px; }
    button { padding: 15px 25px; font-size: 18px; background: #ff7a59; color: white; border: none; border-radius: 10px; cursor: pointer; }
    .msg { margin: 10px 0; padding: 10px 14px; background: #fffbe6; border-radius: 15px; max-width: 80%; word-wrap: break-word; }
    .my { background: #ff7a59; color: white; margin-left: auto; text-align: right; }
  </style>
</head>
<body>
  <h1>–†–∞–∑–±–µ–π—Ç–µ —è–π—Ü–æ –≤–º–µ—Å—Ç–µ! ü•ö‚ù§Ô∏è</h1>
  <div id="egg">ü•ö</div>
  <div id="counter">–û—Å—Ç–∞–ª–æ—Å—å –∫–ª–∏–∫–æ–≤: <span id="clicks">1000</span></div>
  
  <div id="win">
    üéâ –Ø–ô–¶–û –†–ê–ó–ë–ò–¢–û! üéâ<br><br>
    –í—ã —Å –ª—é–±–∏–º—ã–º —á–µ–ª–æ–≤–µ–∫–æ–º ‚Äî –Ω–∞—Å—Ç–æ—è—â–∞—è –∫–æ–º–∞–Ω–¥–∞ –º–µ—á—Ç—ã! üêî‚ù§Ô∏è<br>
    –õ—é–±–≤–∏ –≤–∞–º –∏ –º–∏–ª–ª–∏–æ–Ω —Ç–∞–∫–∏—Ö —è–∏—Ü –µ—â—ë! üíï
  </div>

  <div id="chat"></div>
  <input type="text" id="msg" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –Ω–∞–∂–º–∏ Enter..." autocomplete="off" />
</body>
</html>
