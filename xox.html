<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Точковка</title>

<style>
  :root {
    --glass: rgba(255,255,255,0.08);
    --glass2: rgba(255,255,255,0.14);
    --border: rgba(255,255,255,0.22);
    --accent: #0a84ff;
    --green: #30d158;
    --red: #ff453a;
    --orange: #ff9f0a;
  }

  * { margin:0; padding:0; box-sizing:border-box }
  html,body {
    height:100dvh;
    background:#000;
    overflow:hidden;
    font-family:-apple-system, system-ui, sans-serif;
    color:#fff;
  }

  body { display:flex; flex-direction:column }

  /* VisionOS Header */
  header {
    font-size:40px;
    font-weight:900;
    padding:50px 20px 20px;
    text-align:center;
    background:linear-gradient(90deg,#0a84ff,#30d158);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    text-shadow:0 0 40px rgba(10,132,255,0.4);
  }

  /* План */
  .plan {
    margin:0 16px 14px;
    padding:20px;
    background:var(--glass);
    border-radius:24px;
    border:1px solid var(--border);
    backdrop-filter:blur(28px);
    box-shadow:0 0 60px rgba(255,255,255,0.05);
  }

  #plan {
    width:100%;
    padding:12px;
    font-size:42px;
    text-align:center;
    font-weight:800;
    background:var(--glass2);
    border:1px solid var(--border);
    border-radius:18px;
    color:#fff;
  }

  .pr {
    height:14px;
    background:rgba(255,255,255,0.15);
    border-radius:7px;
    overflow:hidden;
    margin:16px 0;
  }

  .fill {
    height:100%;
    width:0%;
    background:linear-gradient(90deg,var(--accent),var(--green));
    transition:width .6s;
    box-shadow:0 0 16px rgba(10,132,255,0.5);
  }

  .fill.over {
    background:linear-gradient(90deg,var(--green),var(--orange));
  }

  .done {
    text-align:center;
    font-size:32px;
    font-weight:900;
    margin-top:4px;
  }

  .left {
    text-align:center;
    font-size:22px;
    font-weight:600;
    margin-top:4px;
    color:var(--orange);
  }

  /* VisionOS Cards */
  .list {
    flex:1;
    overflow-y:auto;
    padding:0 16px 120px;
    -webkit-overflow-scrolling:touch;
  }

  .t {
    display:flex;
    align-items:center;
    padding:18px 18px;
    background:var(--glass2);
    border-radius:22px;
    border:1px solid var(--border);
    backdrop-filter:blur(26px);
    margin-bottom:14px;
    position:relative;
    overflow:hidden;
    box-shadow:0 0 50px rgba(255,255,255,0.04);
    transition:0.25s;
  }

  .t:active {
    transform:scale(0.98);
  }

  /* Swipe Delete BG */
  .del-bg {
    position:absolute;
    left:0; top:0; bottom:0;
    width:110px;
    background:var(--red);
    color:#fff;
    display:flex;
    justify-content:center;
    align-items:center;
    font-size:20px;
    border-radius:22px;
  }

  .chk { margin-right:14px; width:30px; height:30px }

  .n {
    width:80px;
    text-align:center;
    font-size:34px;
    font-weight:900;
  }

  .b {
    width:56px;
    height:56px;
    border-radius:28px;
    font-size:36px;
    border:none;
    color:#fff;
    margin:0 10px;
    background:var(--accent);
    box-shadow:0 0 18px rgba(10,132,255,0.4);
  }

  .b.m { background:var(--red) }

  .c {
    font-size:50px;
    min-width:110px;
    text-align:center;
    font-weight:900;
    cursor:pointer;
  }

  .v {
    margin-left:auto;
    padding:7px 14px;
    background:rgba(10,132,255,0.25);
    border-radius:12px;
    font-size:22px;
    font-weight:700;
  }

  /* Floating FAB */
  .fab {
    position:fixed;
    bottom:max(24px,env(safe-area-inset-bottom));
    left:50%;
    transform:translateX(-50%);
    width:62px;
    height:62px;
    border-radius:31px;
    border:none;
    background:var(--accent);
    font-size:32px;
    color:#fff;
    box-shadow:0 0 35px rgba(10,132,255,0.5);
    z-index:99;
  }

  /* Sheet */
  .sh {
    position:fixed;
    left:0; right:0;
    bottom:-320px;
    background:rgba(20,20,35,0.95);
    backdrop-filter:blur(40px);
    border-radius:28px 28px 0 0;
    padding:22px;
    padding-bottom:max(40px,env(safe-area-inset-bottom));
    transition:bottom .35s cubic-bezier(0.16,1,0.3,1);
    z-index:150;
  }

  .sh.open { bottom:0 }

  .h {
    width:46px;
    height:6px;
    background:#666;
    border-radius:3px;
    margin:0 auto 18px;
  }

  .sh button {
    width:100%;
    padding:20px;
    background:var(--glass2);
    border:none;
    border-radius:18px;
    font-size:22px;
    font-weight:700;
    color:#fff;
    margin-bottom:14px;
    backdrop-filter:blur(20px);
  }
</style>
</head>

<body>

<header>Точковка</header>

<div class="plan">
  <input id="plan" type="number" value="3000">
  <div class="pr"><div class="fill" id="f"></div></div>
  <div class="done" id="done">0 м³</div>
  <div class="left" id="left">Осталось: 3000 м³</div>
</div>

<div class="list" id="list"></div>

<button class="fab" onclick="s.classList.toggle('open')">⋯</button>

<div class="sh" id="s">
  <div class="h"></div>
  <button onclick="add();s.classList.toggle('open')">+ Добавить БелАЗ</button>
  <button onclick="wa();s.classList.toggle('open')">Диспетчеру в WhatsApp</button>
  <button onclick="res();s.classList.toggle('open')" style="background:rgba(255,59,48,0.35)">Сбросить смену</button>
</div>

<script>
let trucks = JSON.parse(localStorage.getItem('toch2025_final')) || [];
let target = +localStorage.getItem('target2025') || 3000;

document.getElementById('plan').value = target;

trucks = trucks.map(x => ({
  n: x.n || "??",
  c: x.c || 0,
  v: x.v || 37.8,
  on: x.on !== false
}));

function save(){
  localStorage.setItem('toch2025_final', JSON.stringify(trucks));
  localStorage.setItem('target2025', target);
}

function update(){
  const total = trucks.reduce((s,x)=>s + (x.on ? x.c*x.v : 0), 0);
  const left = Math.max(0, target - total);

  document.getElementById('f').style.width = Math.min(total/target*100,120) + '%';
  document.getElementById('f').classList.toggle('over', total > target);

  document.getElementById('done').textContent = Math.round(total).toLocaleString() + " м³";
  document.getElementById('left').textContent =
    left === 0 ? "НОРМА ВЫПОЛНЕНА" : `Осталось: ${Math.round(left).toLocaleString()} м³`;
}

function render(){
  list.innerHTML = trucks.map((x,i)=>`
    <div class="t" data-i="${i}" onpointerdown="sw(event,this)">
      <div class="del-bg">Удалить</div>
      <input type="checkbox" class="chk" ${x.on?"checked":""} onchange="tog(${i})">
      <div class="n">${x.n}</div>
      <button class="b m" onclick="event.stopPropagation();ch(${i},-1)">–</button>
      <div class="c" onclick="event.stopPropagation();ch(${i},5)">${x.c}</div>
      <button class="b" onclick="event.stopPropagation();ch(${i},1)">+</button>
      <div class="v" onclick="event.stopPropagation();cv(${i})">${x.v} м³</div>
    </div>
  `).join('');
  update();
}

window.tog = i => {
  trucks[i].on = !trucks[i].on;
  save(); render();
};

window.ch = (i,d) => {
  trucks[i].c = Math.max(0, trucks[i].c + d);
  save(); render();
  navigator.vibrate?.(30);
};

window.cv = i => {
  let v = prompt("Кубатура", trucks[i].v);
  if(v && !isNaN(v)){
    trucks[i].v = +v;
    save(); render();
  }
};

let sx = 0;
window.sw = (e, el) => {
  if(e.pointerType === "mouse") return;
  sx = e.touches[0].clientX;

  const move = ev => {
    let d = ev.touches[0].clientX - sx;
    if(d < 0) el.style.transform = `translateX(${d}px)`;
  };

  const end = ev => {
    const d = ev.changedTouches[0].clientX - sx;
    if(d < -90){
      trucks.splice(+el.dataset.i,1);
      save(); render();
    } else {
      el.style.transform = "";
    }
    document.removeEventListener('touchmove', move);
    document.removeEventListener('touchend', end);
  };

  document.addEventListener('touchmove', move);
  document.addEventListener('touchend', end);
};

window.add = () => {
  let n = prompt("Номер БелАЗа")?.trim().toUpperCase();
  if(!n || trucks.some(x=>x.n===n)) return;
  let v = prompt("Кубатура", 37.8) || 37.8;

  trucks.push({ n, c:0, v:+v, on:true });
  save(); render();
};

window.wa = () => {
  const txt = trucks
    .filter(x=>x.on && x.c>0)
    .map(x => `${x.n} — ${x.c}`)
    .join('\n') || "—";

  location.href = "whatsapp://send?text=" + encodeURIComponent(txt);
};

window.res = () => {
  if(confirm("Сбросить смену?")){
    trucks = [];
    save();
    render();
  }
};

document.getElementById('plan').onchange = e => {
  target = +e.target.value || 3000;
  save();
  update();
};

render();
</script>

</body>
</html>