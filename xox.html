<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏ –¥–ª—è –Ω–∞—Å —Å —Ç–æ–±–æ–π ‚ù§Ô∏è</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      text-align: center;
      background: linear-gradient(135deg, #ff9a9e, #fad0c4);
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #333;
    }
    h1 { color: white; margin-bottom: 10px; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
    #status { font-size: 1.6em; margin: 20px; color: white; min-height: 50px; }
    #board {
      display: grid;
      grid-template-columns: repeat(3, 110px);
      grid-gap: 12px;
      margin: 20px auto;
    }
    .cell {
      width: 110px;
      height: 110px;
      background: white;
      border-radius: 20px;
      font-size: 80px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 15px rgba(0,0,0,0.2);
      transition: all 0.2s;
    }
    .cell:hover { background: #fff0f5; transform: scale(1.05); }
    button {
      padding: 15px 35px;
      font-size: 1.3em;
      background: #ff4757;
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      margin-top: 20px;
      box-shadow: 0 4px 15px rgba(255,71,87,0.4);
    }
    button:hover { background: #ff3742; }
    #link {
      background: rgba(255,255,255,0.9);
      padding: 15px;
      border-radius: 15px;
      margin: 20px;
      word-break: break-all;
      max-width: 90%;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <h1>–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏ –¥–ª—è –≤–ª—é–±–ª—ë–Ω–Ω—ã—Ö ‚ù§Ô∏è</h1>
  <div id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  <div id="board"></div>
  <button onclick="resetGame()">üîÑ –ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
  <div id="link">–û—Ç–ø—Ä–∞–≤—å —ç—Ç—É —Å—Å—ã–ª–∫—É –ª—é–±–∏–º–æ–π ‚ù§Ô∏è<br><b id="url"></b></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDS3YUcSW26NDSJJAxbvQdJDwHTpUN-k5A",
      authDomain: "xox-gamelove.firebaseapp.com",
      databaseURL: "https://xox-gamelove-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "xox-gamelove",
      storageBucket: "xox-gamelove.firebasestorage.app",
      messagingSenderId: "99410167270",
      appId: "1:99410167270:web:c44b4f7f22a88a2db34227"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ID –∫–æ–º–Ω–∞—Ç—ã
    const urlParams = new URLSearchParams(window.location.search);
    let roomId = urlParams.get('room');
    if (!roomId) {
      roomId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
      history.replaceState(null, null, '?room=' + roomId);
    }
    document.getElementById('url').textContent = location.href;

    const roomRef = db.ref('rooms/' + roomId);
    const boardRef = roomRef.child('board');
    const turnRef = roomRef.child('turn');
    const winnerRef = roomRef.child('winner');

    let mySymbol = null;
    let isMyTurn = false;

    // –°–æ–∑–¥–∞—ë–º –ø–æ–ª–µ
    const boardDiv = document.getElementById('board');
    for (let i = 0; i < 9; i++) {
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.dataset.index = i;
      cell.onclick = () => makeMove(i);
      boardDiv.appendChild(cell);
    }

    function makeMove(index) {
      if (!isMyTurn || boardDiv.children[index].textContent || winnerRef.val()) return;
      boardRef.child(index).set(mySymbol);
      turnRef.set(mySymbol === 'X' ? 'O' : 'X');
    }

    function resetGame() {
      if (confirm('–ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É?')) {
        boardRef.set(Array(9).fill(null));
        turnRef.set('X');
        winnerRef.set(null);
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–Ω–∞—Ç—ã
    roomRef.child('board').set(Array(9).fill(null));
    roomRef.child('turn').set('X');
    roomRef.child('winner').set(null);

    // –°–ª—É—à–∞–µ–º –¥–æ—Å–∫—É
    boardRef.on('value', snap => {
      const data = snap.val() || Array(9).fill(null);
      document.querySelectorAll('.cell').forEach((cell, i) => {
        cell.textContent = data[i] || '';
      });
      checkWinner(data);
    });

    // –°–ª—É—à–∞–µ–º —á–µ–π —Ö–æ–¥ –∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
    turnRef.on('value', snap => {
      const turn = snap.val();
      winnerRef.once('value', w => {
        const winner = w.val();
        if (winner) {
          if (winner === 'draw') {
            document.getElementById('status').textContent = '–ù–∏—á—å—è üòò';
          } else {
            document.getElementById('status').textContent = `–ü–æ–±–µ–¥–∏–ª ${winner} üéâüéâüéâ`;
          }
        } else {
          isMyTurn = (mySymbol === turn);
          document.getElementById('status').textContent = 
            isMyTurn ? '–¢–≤–æ–π —Ö–æ–¥!' : `–•–æ–¥ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ ${turn === 'X' ? '‚ùå' : '‚≠ï'}`;
        }
      });
    });

    // –ù–∞–∑–Ω–∞—á–∞–µ–º —Å–∏–º–≤–æ–ª—ã
    roomRef.child('players').transaction(current => (current || 0) + 1, (error, committed, snapshot) => {
      if (committed) {
        const count = snapshot.val();
        if (count === 1) {
          mySymbol = 'X';
          document.getElementById('status').textContent = '–¢—ã ‚ùå ‚Äî –∂–¥—ë–º —Ç–≤–æ—é –ª—é–±–∏–º—É—é...';
        } else if (count === 2) {
          mySymbol = 'O';
          document.getElementById('status').textContent = '–¢—ã ‚≠ï ‚Äî —Ö–æ–¥–∏—Ç ‚ùå';
        } else {
          alert('–ö–æ–º–Ω–∞—Ç–∞ –ø–æ–ª–Ω–∞—è ‚Äî —Å–æ–∑–¥–∞–π –Ω–æ–≤—É—é –∏–≥—Ä—É!');
          document.getElementById('status').textContent = '–ö–æ–º–Ω–∞—Ç–∞ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∞';
        }
      }
    });

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–±–µ–¥—ã
    function checkWinner(b) {
      const win = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
      for (let c of win) {
        if (b[c[0]] && b[c[0]] === b[c[1]] && b[c[0]] === b[c[2]]) {
          winnerRef.set(b[c[0]]);
          return;
        }
      }
      if (b.every(cell => cell !== null)) {
        winnerRef.set('draw');
      }
    }

    // –£–±–∏—Ä–∞–µ–º –∏–≥—Ä–æ–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
    window.addEventListener('beforeunload', () => {
      roomRef.child('players').transaction(c => (c || 0) - 1);
    });
  </script>
</body>
</html>
