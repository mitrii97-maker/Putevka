<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Экскаватор</title>
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  html, body {
    height: 100dvh;
    overflow: hidden;
    font-family: -apple-system, SF Pro Display, sans-serif;
    background: #000;
    color: #fff;
  }

  header {
    text-align: center;
    padding: 44px 20px 16px;
    font-size: 36px;
    font-weight: 800;
    letter-spacing: -0.8px;
  }

  .plan-card {
    margin: 0 16px 16px;
    padding: 20px;
    background: rgba(255,255,255,0.08);
    border-radius: 20px;
    backdrop-filter: blur(20px);
  }

  #plan {
    width: 100%;
    padding: 12px;
    font-size: 48px;
    font-weight: 800;
    text-align: center;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 16px;
    color: #fff;
  }

  .progress {
    height: 14px;
    background: rgba(255,255,255,0.15);
    border-radius: 7px;
    overflow: hidden;
    margin: 16px 0;
  }
  .fill {
    height: 100%;
    width: 0%;
    background: #30d158;
    transition: width 0.6s ease;
  }
  .over { background: #ff9f0a; }

  .stats {
    text-align: center;
    font-size: 32px;
    font-weight: 800;
  }
  .remain {
    text-align: center;
    font-size: 24px;
    color: #ff9f0a;
    margin-top: 8px;
    font-weight: 600;
  }

  .trucks {
    flex: 1;
    overflow-y: auto;
    padding: 0 16px 100px;
    -webkit-overflow-scrolling: touch;
  }

  .truck {
    display: flex;
    align-items: center;
    padding: 18px 20px;
    background: rgba(255,255,255,0.08);
    border-radius: 18px;
    margin-bottom: 12px;
    position: relative;
    overflow: hidden;
  }

  .num { font-size: 36px; font-weight: 800; width: 80px; text-align: center; }
  .count { font-size: 56px; font-weight: 900; min-width: 110px; text-align: center; }
  .vol {
    margin-left: auto;
    padding: 8px 16px;
    background: rgba(0,122,255,0.2);
    border-radius: 12px;
    font-size: 24px;
    font-weight: 700;
  }

  .btn {
    width: 68px; height: 68px; border-radius: 34px; border: none;
    font-size: 40px; color: white; font-weight: bold;
    margin: 0 16px;
  }
  .plus { background: #007aff; }
  .minus { background: #ff3b30; }

  /* Нижнее выезжающее меню */
  .sheet {
    position: fixed;
    bottom: -300px;
    left: 0; right: 0;
    background: rgba(30,30,30,0.95);
    backdrop-filter: blur(30px);
    border-radius: 24px 24px 0 0;
    padding: 20px;
    padding-bottom: max(40px, env(safe-area-inset-bottom));
    transition: bottom 0.4s cubic-bezier(0.16,1,0.3,1);
    z-index: 100;
  }
  .sheet.open { bottom: 0; }

  .handle {
    width: 40px; height: 5px; background: #666; border-radius: 3px;
    margin: 0 auto 20px;
  }

  .sheet button {
    width: 100%;
    padding: 18px;
    margin-bottom: 12px;
    background: rgba(255,255,255,0.1);
    border: none;
    border-radius: 16px;
    color: white;
    font-size: 20px;
    font-weight: 600;
  }

  .fab {
    position: fixed;
    bottom: max(24px, env(safe-area-inset-bottom));
    left: 50%;
    transform: translateX(-50%);
    width: 64px; height: 64px;
    background: #007aff;
    border-radius: 32px;
    font-size: 32px;
    color: white;
    border: none;
    box-shadow: 0 8px 30px rgba(0,122,255,0.4);
    z-index: 99;
  }
</style>
</head>
<body>

<header>Экскаватор</header>

<div class="plan-card">
  <input id="plan" type="number" value="3000">
  <div class="progress"><div class="fill" id="fill"></div></div>
  <div class="stats" id="done">0 м³</div>
  <div class="remain" id="remain">Осталось: 3000 м³</div>
</div>

<div class="trucks" id="list"></div>

<button class="fab" onclick="toggleSheet()">⋯</button>

<div class="sheet" id="sheet">
  <div class="handle"></div>
  <button onclick="addTruck(); toggleSheet()">+ Добавить БелАЗ</button>
  <button onclick="shareShift(); toggleSheet()">Поделиться сменой</button>
  <button onclick="resetShift(); toggleSheet()" style="background:rgba(255,59,48,0.3)">Сбросить смену</button>
</div>

<script>
  let trucks = JSON.parse(localStorage.getItem('exc_strict')) || [];
  let target = +localStorage.getItem('exc_target') || 3000;

  // Совместимость со старыми данными
  trucks = trucks.map(t => ({
    n: t.n || t.num || '??',
    c: t.c || t.trips || 0,
    v: t.v || 37.8
  }));

  document.getElementById('plan').value = target;

  function save() {
    localStorage.setItem('exc_strict', JSON.stringify(trucks));
    localStorage.setItem('exc_target', target);
  }

  function update() {
    const done = trucks.reduce((s,t) => s + t.c * t.v, 0);
    const left = Math.max(0, target - done);
    const perc = Math.min((done / target) * 100, 200);

    document.getElementById('fill').style.width = perc + '%';
    document.getElementById('done').textContent = `${Math.round(done).toLocaleString()} м³`;
    document.getElementById('remain').textContent = left === 0 ? 'Норма выполнена!' : `Осталось: ${Math.round(left).toLocaleString()} м³`;
    document.getElementById('fill').classList.toggle('over', done > target);
  }

  function render() {
    document.getElementById('list').innerHTML = trucks.map((t,i) => `
      <div class="truck" data-i="${i}" onpointerdown="swipeStart(event,this)">
        <div style="position:absolute;left:0;top:0;bottom:0;width:90px;background:#ff3b30;color:white;display:flex;align-items:center;justify-content:center;font-size:24px;transform:translateX(-100%)">
          Удалить
        </div>
        <div style="widthрева:100%;display:flex;align-items:center">
          <div class="num">${t.n}</div>
          <button class="btn minus" onclick="event.stopPropagation(); ch(${i},-1)">–</button>
          <div class="count" onclick="event.stopPropagation(); ch(${i},5)" style="cursor:pointer">${t.c}</div>
          <button class="btn plus" onclick="event.stopPropagation(); ch(${i},1)">+</button>
          <div class="vol" onclick="event.stopPropagation(); changeV(${i})">${t.v} м³</div>
        </div>
      </div>
    `).join('');
    update();
  }

  window.ch = (i,d) => { trucks[i].c = Math.max(0, trucks[i].c + d); save(); render(); navigator.vibrate?.(30); }
  window.changeV = (i) => {
    const v = prompt(`Кубатура ${trucks[i].n}`, trucks[i].v);
    if (v && !isNaN(v)) { trucks[i].v = +(+v).toFixed(1); save(); render(); }
  }

  let startX = 0;
  window.swipeStart = (e, el) => {
    if (e.pointerType === 'mouse') return;
    startX = e.touches[0].clientX;
    const move = e => {
      const diff = e.touches[0].clientX - startX;
      if (diff < 0) el.style.transform = `translateX(${diff}px)`;
    };
    const end = e => {
      if (e.changedTouches[0].clientX - startX < -100) {
        trucks.splice(el.dataset.i, 1);
        save(); render();
      } else el.style.transform = '';
      document.removeEventListener('touchmove', move);
      document.removeEventListener('touchend', end);
    };
    document.addEventListener('touchmove', move);
    document.addEventListener('touchend', end);
  }

  window.addTruck = () => {
    const n = prompt('Номер БелАЗа')?.trim().toUpperCase();
    if (!n) return;
    if (trucks.some(t=>t.n===n)) return alert('Уже есть');
    const v = prompt('Кубатура, м³', '37.8') || 37.8;
    trucks.push({n, c:0, v:+v});
    save(); render();
  }

  window.shareShift = () => {
    const done = trucks.reduce((s,t)=>s+t.c*t.v,0);
    const text = trucks.filter(t=>t.c>0).map(t=>`${t.n} — ${t.c} рейс. (${t.v} м³)`).join('\n') || 'Рейсов нет';
    navigator.clipboard.writeText(text + `\n\nИтого: ${Math.round(done)} м³ / ${target}`);
    alert('Скопировано диспетчеру');
  }

  window.resetShift = () => confirm('Сбросить смену?') && (trucks=[], save(), render());

  document.getElementById('plan').onchange = e => { target = +e.target.value || 3000; save(); update(); };

  window.toggleSheet = () => document.getElementById('sheet').classList.toggle('open');

  render();
</script>
</body>
</html>
